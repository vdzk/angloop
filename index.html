<html>
  <head>
    <title>
      Angloop!
    </title>
    <style>
      svg {
        padding: 3px;
      }
      .cont {
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div id="svgs"></div>
    <script>
      let size = 128
      function draw({loops, sides, commands}) {
        const turn = (loops * Math.PI * 2) / sides  //In radians
        let angle = turn
        let lastPoint = {x: 0, y: 0}
        const points = [{x: 0, y: 0}]
        for (let s = 0; s < sides; s++) {
          [...commands].forEach(c => {
            if (c === 'F') {
              const {x, y} = lastPoint
              const dx = Math.cos(angle)
              const dy = Math.sin(angle)
              const nextPoint = {
                x: x + dx,
                y: y + dy,
              }
              points.push(nextPoint)
              lastPoint = nextPoint
            } else if (c === 'R') {
              angle += turn
            } else if (c === 'L') {
              angle -= turn
            }
          })
        }
        let minX = 0
        let minY = 0
        let maxX = 0
        let maxY = 0
        points.forEach(point => {
          const {x, y} = point
          minX = Math.min(minX, x)
          minY = Math.min(minY, y)
          maxX = Math.max(maxX, x)
          maxY = Math.max(maxY, y)
        })
        const length = maxX - minX
        const height = maxY - minY
        const scale = size / Math.max(length, height)
        points.forEach(point => {
          const {x, y} = point
          point.x = (x - minX) * scale + 1
          point.y = (y - minY) * scale + 1
        })
        const svgEl = document.createElementNS("http://www.w3.org/2000/svg", "svg")
        svgEl.setAttribute('width', size+2+'px')
        svgEl.setAttribute('height', size+2+'px')
        for (let i = 0; i < points.length - 1; i++) {
          const lineEl = document.createElementNS('http://www.w3.org/2000/svg','line');
          lineEl.setAttribute('x1', points[i].x);
          lineEl.setAttribute('y1', points[i].y);
          lineEl.setAttribute('x2', points[i+1].x);
          lineEl.setAttribute('y2', points[i+1].y);
          lineEl.setAttribute("stroke", "black")
          svgEl.append(lineEl);
        }
        const contEl = document.createElement('div')
        contEl.classList.add('cont')
        contEl.setAttribute('title', (sides / loops)+commands)
        contEl.append(svgEl)
        document.getElementById('svgs').append(contEl)
      }

      function simplify(commands) {
        let simplified = true
        while (simplified) {
          simplified = false
          let newCommands = commands

          //Remove cancelled out turns e.g. LR or RXXXXXXL
          if ((commands[0] === 'L' && commands[commands.length - 1] === 'R') || (commands[0] === 'R' && commands[commands.length - 1] === 'L')) {
            newCommands = newCommands.slice(1, -1)
          }
          newCommands = newCommands.replace('RL', '')
          newCommands = newCommands.replace('LR', '')

          if (newCommands !== commands) {
            commands = newCommands
            simplified = true
          }
        }

        return commands
      }

      //Check if the repeating moves forward be simplified.
      function uniqueForward(commands) {
        let fs = [0]
        for (const move of commands) {
          if (move === 'F') {
            fs[fs.length - 1]++
          } else {
            fs.push(0)
          }
        }
        //Case where start and end is an 'F'
        fs[0] += fs[fs.length - 1]
        fs.splice(-1,1)
        fs = fs.filter(n => n !== 0)
        const min = Math.min( ...fs )
        if (min > 1) {
          for (let d = 2; d <= min; d++) {
            const canDivide = fs.every(n => (n % d) === 0)
            if (canDivide) {
              return false
            }
          }
        }
        return true
      }

      //TODO: Do the same for angles

      const angles = {}
      function interesting({loops, sides, commands}) {
        if (sides !== 7) {
          return false;
        }

        //Ignore straight lines
        let totalTurn = 0
        for (const move of commands) {
          if (move === 'L') {
            totalTurn--
          } else if ( move === 'R') {
            totalTurn++
          }
        }
        if (totalTurn === 0) {
          return false
        }

        //Ignore boring angles
        const angle = sides / loops
        if (angle === 2 || angle === 1 || angle < 1) {
          return false
        }
        const totalAnggle = Math.abs(angle / totalTurn)
        if (totalAnggle === 2 || totalAnggle === 1 || totalAnggle < 1) {
          return false
        }

        angles[angle] = angles[angle] || []
        if (angles[angle].includes(commands)) {
          return false
        } else {
          angles[angle].push(commands)
          return true
        }
      }

      const moves = ['F', 'R', 'L']
      function recMove(config, commandsSupply) {
        if (commandsSupply === 0) {
          config.commands = simplify(config.commands)
          if (uniqueForward(config.commands)) {
            if (interesting(config)) {
              draw(config)
            }
          }
        } else {
          for (const move of moves) {
            recMove({...config, commands: config.commands + move}, commandsSupply - 1)
          }
        }
      }

      const minSupply = 1
      const maxSupply = 12
      for (let supply = minSupply; supply < maxSupply; supply++) {
        for (let s = 0; s <= supply; s++) {
          const angleSupply = s
          const commandsSupply = supply - s
          for (let as = 0; as <= angleSupply; as++) {
            const loopsSupply = as
            const sidesSupply = angleSupply - as
            const newConfig = {
              loops: 1 + loopsSupply,
              sides: 3 + sidesSupply,
              commands: 'F'
            }
            recMove(newConfig, commandsSupply)
          }
        }
      }
    </script>
  </body>
</html>
